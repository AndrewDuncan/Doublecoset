\documentclass[a4paper,12pt]{article}
\usepackage{amsmath,amsfonts,amsthm,amscd,amssymb,latexsym,comment,eufrak}
%%%%%%%%%%%%%
\usepackage{enumerate,graphicx,psfrag,subfigure}%,jchangebar,oldgerm}
\usepackage[mathscr]{eucal}
\usepackage[usenames]{color}
%\usepackage{showkeys}
%%%%%%%%%
\sloppy
%%%%%%%%%%%%%%%%%%%%%%%
%
%
%
\title{The subgroup membership problem
}
\author{ 
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%%%%%%%%%%%%%%%%%%%%%%%%%%

\def\nul{\emptyset }
\def\D{\Delta }
\def\d{\delta }
%\def\vd{\vardelta}
\def\b{\beta }
\def\z{\zeta }
\def\i{\iota }
\def\k{\kappa }
\def\l{\lambda }
\def\L{\Lambda }
\def\r{\rho }
\def\x{\chi }
\def\ep{\epsilon}
\def\e{\varepsilon }
\def\G{\Gamma }
\def\g{\gamma }
\def\a{\alpha }
\def\t{\tau }
\def\th{\theta}
\def\s{\sigma }
\def\S{\Sigma }
\def\W{\Omega}
\def\w{\omega }
\def\pd{\partial}
\def\wht{\widehat}
%\def\cC{{\mathcal C}}
%\newcommand{\cdim}{\texttt{cdim}}
\def\fC{{\textswab C}}
%
\def\cD{{\cal{D}}}
\def\cF{{\cal{F}}}
\def\cH{{\cal{H}}}
\def\cJ{{\cal{J}}}

\def\cK{{\cal{K}}}
\def\cP{{\cal{P}}}
\def\cR{{\cal{R}}}
\def\cS{{\cal{S}}}
\def\cW{{\cal{W}}}
\def\cQ{{\cal{Q}}}
%\newcommand{\GG}{\ensuremath{\mathbb{G}}}
\newcommand{\pp}{\mathbf{p}}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\newtheorem{theorem}{Theorem}[section]
\newtheorem{lemma}[theorem]{Lemma}
\newtheorem{corollary}[theorem]{Corollary}
\newtheorem{proposition}[theorem]{Proposition}
\newtheorem{axiom}[theorem]{Axiom}
\newtheorem{definition}[theorem]{Definition}
\newtheorem*{defn*}{Definition}
\newtheorem{conjecture}[theorem]{Conjecture}
%cvs -d :pserver:najd2@cvs.mas.ncl.ac.uk:/CVS/najd2
\newtheorem{exam}[theorem]{Example}
%
%
\newenvironment{example}{\begin{exam} \rm}{\end{exam}}
%
%
%
\newtheorem{remk}[theorem]{Remark}
\newenvironment{remark}{\begin{remk} \rm}{\end{remk}}
%
%%%%%%%%%%%%
\numberwithin{equation}{section}
\numberwithin{figure}{section}
%%%%%%%%%%%%%%%%%%%%
\newcommand{\Iso}{\operatorname{Isom}}
\newcommand{\Aut}{\operatorname{Aut}}
%%%%%%%%%%%%%%%%%%%
\renewcommand{\AA}{\ensuremath{\mathbb{A}}}
\newcommand{\ZZ}{\ensuremath{\mathbb{Z}}}
\newcommand{\QQ}{\ensuremath{\mathbb{Q}}}
\newcommand{\RR}{\ensuremath{\mathbb{R}}}
\newcommand{\NN}{\ensuremath{\mathbb{N}}}
\newcommand{\CC}{\ensuremath{\mathbb{C}}}
\newcommand{\FF}{\ensuremath{\mathbb{F}}}
%\renewcommand{\ker}{\verb"Ker"}
\newcommand{\cC}{\mathcal{C}}
\newcommand{\cO}{\mathcal{O}}
\newcommand{\la}{\langle}
\newcommand{\ra}{\rangle}
%\newcommand{\BA}{\ensuremath{\mathbb{A}}}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\newcommand{\maps}{\rightarrow}
\newcommand{\ov}[1]{\overline{#1}}
\newcommand{\bs}{\backslash}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\newcommand{\be}{\begin{enumerate}}
\newcommand{\ee}{\end{enumerate}}
\newcommand{\bd}{\begin{description}}
\newcommand{\ed}{\end{description}}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% 
%
\newenvironment{ajd}{\noindent\color{blue} AJD }{}
\newenvironment{xxx}{\noindent\color{red}}{}
%
\begin{document}
\maketitle
\section{Double coset normal form}
Based on notes copied (laboriously) from Christian's page 
\begin{verbatim}
http://checkmyworking.com/misc/writemaths/?doublecoset
\end{verbatim}
$F_1$, $F_2$ free groups (finitely generated by $X_1$ 
and $X_2$, respectively).

Let $H_1 \leq F_1$, $H_2 \leq F_2$ such that 
there exists an isomorphism $\phi: H_1 \rightarrow H_2$.

i.e. we have finite bases $\{h_1, \ldots, h_m \}$  for $H_1$ and 
$\{h_1', \ldots, h_m'\}$ for $H_2$.

Consider the free group $F(Z)$, generated by $Z=\{z_1, \ldots, z_m\}$, 
and the maps $\phi_1$ and $\phi_2$ such that 
$\phi_1(z_i)=h_i(X_1)  $ and  $\phi_2(z_i)=h^\prime_i(X_2)$, $i=1,\ldots ,m$.
Thus $\phi_i$ extends to an isomorphism of $F(Z)$ to $H_i$. 

Let ${G = F_1 \underset{H_1=H_2}{\ast} F_2}$, the group with  
 presentation $\la X_1,X_2 | h_i = h_i', i=1 \ldots m\ra$.

A  set $S_i \subseteq F_i$ such that
\be 
\item
$F_i = \displaystyle{\bigcup_{s \in S_i} H_isH_i}$ 
and 
\item
for all $s, s^\prime \in S_i$, $s\in H_i s^\prime H_i$ 
implies $s=s^\prime$,
\ee
is called a set of \emph{double coset representatives for} $H_i\le F_i$. 
(We shall assume $S_i$ is infinite.) 

Let $S_1$ and $S_2$ be sets of  double coset representatives of 
$H_1\le F_1$ and $H_2\le F_2$, respectively. Let $g \in G$. 
A word $w$ representing $g$ is in \emph{(double coset) normal form} if 
$w = h_{1}p_1h_{2}p_2 \cdots h_{k}p_kh_{{k+1}}$, with
\be
\item $p_i \in S_1\cup S_2$  and $h_i \in F(Z)$ and
\item if $p_i\in S_j$ then $p_{i+1}\notin S_j$, for $j=1$ and $2$,
\ee
for $i = 1 \ldots k+1$.
\section{Finding double coset representatives}
\begin{comment}
Suppose $g = g_1g_2 \cdots g_k$, where $g_i$ is in a factor $F_1$ or 
$F_2$: that is (after free cancellation if necessary) $g_i$ is a 
reduced word in $(X_1\cup X_1^{-1})^\ast$ or $(X_2\cup X_2^{-1})^\ast$
\end{comment}
Given an arbitrary word $g\in F_1\ast F_2$,  
we should like an algorithm to write $g$ in double coset normal form
with respect to some choice of double coset representatives. We may 
assume (after free cancellation if necessary) that $g$ is a 
reduced word in $((X_1\cup X_2)\cup ( X_1^{-1}\cup X_2^{-1}))^\ast$.
 
First we say $g$ is in \emph{reduced form} if $g = g_1 \cdots g_k$, where
$g_1 \in F_1$ or $g_1 \in F_2$ and 
for 
$k > 1$,    $g_i \in F_i \backslash H_i$, for $i=1$ or $2$ 
 and $g_i$, ${g_{i+1}}$ belong to different factors. As $F_1$ and 
$F_2$ have solvable subgroup membership problem we can rewrite $g$ in
reduced form. More precisely, we construct a Stallings automaton $A_i$ for
$H_i\le F_i$ and choose a maximal subtree $T_i$ of $A_i$. 
Then we write $g=f_1\cdots f_r$, in free product normal
form (each $f_i$ in a factor and successive terms from different factors).
Now using the appropriate Stallings automata we write $f_r=h_rs_r$, where
$h_r\in H_i$ and $s_r$ is a coset representative. (Read the maximal 
possible left prefix $w_r$ of $f_r$ in $A_i$. Then $h_r$ is the 
maximal subword of $w_r$ which belongs to $H_i$ and $s_r$ is the
unique word such that $f_r=h_rs_r$, reduced as written.)

Using the maps $\phi_1$ and $\phi_2$ we now write $h_r$ in terms of the
generators of the other factor, to obtain $h^\prime_r$ and then 
replace $f_{r-1}$ with $f_{r-1}h^\prime_r$. Now begin again with
$f_{r-1}$ instead of $f_r$. Continue till the word is exhausted.   
This gives $g=g_1\cdots g_t$ in reduced form.

To rewrite in double coset normal form we need to  
 rewrite
each $g_i$ in double coset normal form in its factor, 
with respect to some (fixed) set
of double coset representatives.  
We now show how to do this.
\subsection{Double coset representatives}
Let $X$ be a finite alphabet, $F=\FF(X)$ and $H$ a finitely generated subgroup
of $F$.  By a {\em reduced} word we mean (in
this section) a freely reduced word in $(X\cup X^{-1})^\ast$, and we write $w\in F(X)$
to mean that $w$ is a reduced word. For $u,v, w\in F(X)$ we 
write $w=u\circ v$ if $|w|=|u|+|v|$, in which case we say that $u$ is a {\em prefix}
of $w$. 

Let $A$ be the Stallings automaton for $H$. We regard $A$ as a 
labelled directed graph
and refer to its states as {\em vertices}. The label of an edge $e$ is denoted 
$l(e)$ and this notation is extended to paths in the obvious way. 
Fix a spanning tree $T$ for $A$. For 
each vertex $v$ of $A$ let $w(v)$ denote the label of the path from $1$ to $v$ in
$T$. We say the word $w$ is {\em readable} by $A$ if, starting in the 
start state $1$ with input $w$, the automaton finishes with the empty
word in some arbitrary state. If $w$ is readable by $A$ we denote the final
state of $A$ after reading $w$ (starting in state $1$) by $\t(w)$. 
If $w$ is readable by $A$ and $\t(w)=1$
 then we say $w$ is {\em accepted} by $A$. Define 
\[L_T=\{w(v): u \textrm{ is a vertex of } A\}.\]  
If $w, s\in F(X)$ then we say that $s$ is a {\em maximal} $L_T${\em -prefix} of $w$ if 
$s\in L_T$, $w=s\circ v$ and no longer prefix of $w$ belongs to $L_T$. 

We shall define a set of double coset representatives for $H$ in two parts. 
First, a word $w\in F(X)$ is a {\em representative of type} $1$ if 
\[w=s\circ e \circ t^{-1},\]
where $s$ is a maximal $L_T$-prefix of $w$, $t$ is a maximal $L_T$-prefix of 
$t\circ e^{-1}$ and $e\neq 1$. Let $S_1$ denote the set of all representatives of 
type $1$. 

To describe the remaining representatives we shall first define an equivalence
relation on the ordered pairs of distinct vertices of $A$. Let
\[P=\{(u,v)\in V(A)\times V(A): u\neq v\}.\]
Define a relation $\sim$ on $P$ by $(u_0,u_1)\sim (v_0,v_1)$ if and only if 
there exist paths $p_0$ and $p_1$ in $A$, from $u_0$ to $v_0$ and $u_1$ to $v_1$ 
respectively, such that $l(p_0)=l(p_1)$. (We allow these paths to have length $0$.)
It is easy to verify that $\sim$ is an equivalence relation on $P$. 

\begin{lemma}\label{lem:equiv_verts}
Let $(u_0,u_1)$ and $(v_0,v_1)$ be elements of $P$ and let 
$a_0=w(u_0)$, $a_1=w(u_1)$, $b_0=w(v_0)$ and $b_1=w(v_1)$. Then 
$(u_0,u_1)\sim (v_0,v_1)$ if and only if there exist $h_0,h_1\in H$ such that
\[a_0a_1^{-1}=h_0b_0b_1^{-1}h_1^{-1}.\]
\end{lemma}  
\begin{proof}
$\Rightarrow$: Let $p_0$ and $p_1$ be paths, from $u_0$ to $v_0$ and $u_1$ to $v_1$ 
respectively, such that $l(p_0)=l(p_1)=c$, say. Set $h_0=a_0cb_0^{-1}$ and 
$h_1=a_1cb_1^{-1}$. Since $h_0$ and $h_1$ are labels of closed paths based at $1$ we
have $h_0$ and $h_1$ in $H$. Thus 
$a_0a_1^{-1}=h_0b_0c^{-1}cb_1^{-1}h_1^{-1}=h_0b_0b_1^{-1}h_1^{-1}$, as required.

$\Leftarrow$: Let $h_0$, $h_1 \in H$ such that $a_0a_1^{-1}=h_0b_0b_1^{-1}h_1^{-1}$. 
Set $k=a_0^{-1}h_0b_0=a_1^{-1}h_1b_1$. Then $h_0=a_0kb_0^{-1}$ and $h_1=a_1kb_1^{-1}$
belong to $H$ so there exist paths $p_0$ and $p_1$, 
from $\t(a_0)=u_0$ to $\t(b_0)=v_0$ and 
$\t(a_1)=u_1$ to $\t(b_1)=v_1$, both with labels $k$. 
Therefore $(u_0,u_1)\sim (v_0,v_1)$. 
\end{proof}  

We shall choose one double coset representative corresponding to each $\sim$ 
equivalence class. To be explicit we make a particular choice of transversal
for the equivalence classes, as follows. 
If $(u,v)\in P$ and $w(u)=a\circ x$, $w(v)=b\circ x$, for some $a,b\in F(X)$ and 
$x\in X^{\pm 1}$, then $(\t(a),\t(b))\in P$ and $(u,v)\sim (\t(a),\t(b))$. It follows
that every equivalence class of $\sim$ contains an element $(a,b)$ such that
$w(a)w(b)^{-1}$ is a reduced word. Let $\pp$ be an equivalence class of $\sim$ and
let $Y$ be the set of all pairs $(u,v)\in \pp$ such that $|w(v)|$ is minimal (amongst
elements of $\pp$). Choose $(u,v)\in Y$ such that $|w(u)|$ is minimal (amongst elements
of $Y$) and define $(u,v)$ to be the $\sim${\em representative} of $\pp$. Fix
one $\sim$ representative for each equivalence class of $\sim$ and  
let $Q$ denote the set of  all these $\sim$ representatives. A word $w\in F(X)$ is
 a {\em representative of type} $2$ if $w=w(u)w(v)^{-1}$, for some $(u,v)\in Q$. 
Let $S_2$ denote the set of all representatives of type $2$ and define $S=S_1\cup S_2$.
(Note that by the minimality conditions of the defintion, if $(u,v)$ is a 
$\sim$ representative then $w(u)w(v)^{-1}=w(u)\circ w(v)^{-1}$.)

\begin{proposition}\label{prop:dcreps}
$S$ is a set of double coset representatives for $H$.
\end{proposition}   
\begin{proof}
First we shall show that every element $w\in F(X)$ lies in $HdH$, for some $d\in S$. 
In fact we describe an algorithm which rewrites a given word $w$ in this form. 

Assume that the Stallings automaton $A$ for $H$ has been constructed by folding from
given generators for $H$. A spanning tree for $A$ may then be found and the 
set $L_T$ computed. For each pair $(u,v)\in P$ the equivalence class $\pp$ of 
$(u,v)$ may be constructed by considering all simple paths (no repeated vertices)
from $u$ to $v$. A pair $(u^\prime ,v^\prime) \in P$ belongs to $\pp$ if and only
if $u^\prime$ lies on a simple path beginning at $u$ and $v^\prime$ lies on 
a simple path beginning at $v$. Having constructed the equivalence classes of $\sim$
 a set of $\sim$ representatives may be constructed, by considering the 
lengths of $w(a)$ and $w(b)$ for all $(a,b)$ in an equivalence class. Thus the
sets $Q$ and $S_2$ may be computed.   \\

\noindent{\bf The algorithm}:\\
Input $w\in F(X)$. 
Let $h$ be the maximal prefix of $w$ accepted by $A$; so $h\in H$ and 
$w=h\circ f$, for some $f\in F(X)$. Now use $A$ to find the maximal $L_T$-prefix $p$ 
of $f$ (that is the maximal prefix which is readable by $A$)
 so $f= p\circ q$, for some $q\in F(X)$. 

Next find the maximal prefix $g$ of $q^{-1}$ acceptable by $A$: say 
$q^{-1}=g\circ r$, for some $r\in F(X)$, and then the maximal $L_T$-prefix 
$t$ of $r$ which
is readable by $A$; say $r=t\circ e^{-1}$, for some $e\in F(X)$. 

If $e\neq 1$ then
\[w=h\circ p \circ e\circ t^{-1}\circ g^{-1},\]
with $h,g\in H$. In this case $p$ and $t$ are readable by $A$. Set $y=w(\t(p))$
and $z=w(\t(t))$. Then $py^{-1}$ and $tz^{-1}$ belong to $H$. Moreover, as $p$
is a maximal $L_T$-prefix of $f$ it is also a maximal $L_T$-prefix of $pet^{-1}$ and so
  the 
first letter of $e$ is not readable from the vertex $\t(p)=\t(y)$. In particular
$ye=y\circ e$. Similarly, the first letter of $e^{-1}$ is not readable from
the vertex $\t(t)=\t(z)$, so $ez^{-1}=e\circ z^{-1}$. Moreover $y$ is a 
maximal $L_T$-prefix of $yez^{-1}$ and $z$ is a maximal $L_T$-prefix of $ze^{-1}$. 
Thus $yez^{-1}\in S_1$ and we output
\[w=(py^{-1}) (yez^{-1})(zt^{-1})\in HSH,\]
of the required form.

On the other hand if $e=1$ then 
\[w=h\circ p\circ t^{-1}\circ g.\]
In this case let $u=\t(p)$ and $v=\t(t)$ and let $(u_0,v_0)$ be the $\sim$ representative
of the equivalence class of $(u,v)$.  Let $y=w(u_0)$ and $z=w(v_0)$. Then,  from Lemma
\ref{lem:equiv_verts}, there exist $h_0,h_1\in H$ such that 
\[w(u)w(v)^{-1}=h_0yz^{-1}h_1^{-1}\]
and we have $p w(u)^{-1}$, $t w(v)^{-1}$ in $H$. Hence 
\[
p\circ t^{-1}=( p w(u)^{-1})w(u)w(v)^{-1}( w(v)t^{-1})=( p w(u)^{-1}) h_0 yz^{-1}
h_1^{-1}( w(v)t^{-1})
\]
and by definition $yz^{-1}\in S_2$. We then output 
\[w=a yz^{-1} b,\]
where $a=h ( p w(u)^{-1}) h_0\in H$ and $b=h_1^{-1}( w(v)t^{-1})g \in H$.

It remains to show that if $s_0,s_1\in S$ with $s_1\in Hs_0H$ then $s_1=s_0$.
Suppose that $s_1=as_0b$, where $a, b\in H$.  
If $s_0\in S_1$, say $s_0=y_0e_0z_0^{-1}$, then, as $ay_0$ and $b^{-1}z_0$ are readable
by $A$ and $e_0\neq 1$, it follows (as above) that $s_1$  
cannot be factored as $s_1=yz^{-1}$,
where both $y$ and $z$ are readable by $A$. Hence both $s_0$ and $s_1$ belong to
$S_1$ or both belong to $S_2$. 

Consider the case where both belong to $S_1$ and, in the usual notation,
$s_i=y_i e_i z_i^{-1}$, $i=0,1$. We have $s_1=as_0b$, $a,b\in H$, and as $y_0$ has
no left divisor in $H$, if $a\neq 1$ then $a$ does not cancel completely with
 a prefix of $y_0$. Thus, if $a\neq 1$ then we may write $a=a_0\circ a_1$ and 
$y_0=a_1^{-1}\circ y_0^\prime$, where $ay_0=a_0\circ y_0^\prime$. Since 
$a$ is accepted by $A$ we have $\t(ay_0)=\t(a_0y_0^\prime)=\t(y_0)$. By definition
of $s_0$ the first letter of $e_0$ is not readable from the vertex $\t(y_0)$, so
it follows, as before that $a_0y_0^\prime e=a_0\circ y_0^\prime \circ e$. Similarly,
if $b\neq 1$ then $b=b_0\circ b_1$ and $z_0=b_0\circ z_0^\prime$, with
$z_0^{-1}b= (z_0^\prime)^{-1}\circ b_1$ and $e (z_0^\prime)^{-1}b_1=
e\circ  (z_0^\prime)^{-1}\circ b_1$. This implies that 
$s_1=a_0\circ y_0^\prime \circ  e\circ  (z_0^\prime)^{-1}\circ b_1$ and by considering 
maximal $L_T$-prefixes of both sides we see that $y_1=a_0\circ y_0^\prime$ and 
$z_1=b_1^{-1}\circ z_0^\prime$. We now have  $\t(y_1)=\t(a_0y_0^\prime)=\t(y_0)$ which
 means that 
$y_0=y_1$ and this in turn implies that $a=1$. Similarly $z_0=z_1$ so $b=1$. 
Hence $s_0=s_1$ in this case.

Finally consider the case where $s_1$ and $s_2$ belong to $S_2$. As $s_1=as_0b$, with
$a,b\in H$, Lemma \ref{lem:equiv_verts} and the definition of $S_2$ imply  that 
$s_0= s_1$. Therefore $S$ is a set of double coset representatives.
\end{proof}



In fact if we don't require uniqueness of representatives then the algorithm 
may be made much simpler than the description above: it can 
simply find the maximal prefix $h_1$ of $w$  accepted  by $A$  and so $w=h_1\circ v$. Then find the
maximal prefix $p$ of $\bar v$ accepted by $A$. Setting $h_2=\bar p$ gives $w=h_1\circ d \circ h_2$, for
some uniquely determined word $d$, which is the (non-unique) 
double coset representative. 


\begin{example}
Picture required: and further work required for the full algorithm.
\begin{align*} 
g &= x_1^3x_2^2y_1y_2 \\ 
&= (x_1^2)(x_1x_2)(x_2^{-1})^{-1} \cdot (y_1)(y_2^{-1})^{-1}
\end{align*}
\end{example}

\subsection{Construction of the normal form}

Now we write each syllable $g_i$ of $g=g_1\cdots g_t$ in normal form using the algorithm above. 
This gives $g_i=h_{i,1}d_ih_{i,2}$, with $d_i\in S_1\cup S_2$. Using $\phi_1$ or $\phi_2$, as appropriate,
we now write $h_{i,1}$ and $h_{i,2}$ as words in $F(Z)$. For $i=1,\ldots , t-1$, we reduce the 
word $h_{i,2}h_{(i+1),1}\in F(Z)$ to give a reduced word $h_i\in F(Z)$ and set $h_0=h_{1,1}$ and  $h_{t+1}=h_{t,2}$.
Then $g$ has normal form $h_0d_1h_1\cdots d_th_{t+1}$.
%
%%%
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% 
\section{The generalised folding process}
The object is to construct an automaton which will accept a word $w$
in double-coset normal form if and only if it belongs to the subgroup $K$.
The idea is to this by starting with the flower automaton for the 
generators of $K$, written in (double-coset) normal form, carrying out
Stallings folding as usual to produce a deterministic, trim, inversive 
automaton, and next adding some additional paths to allow normal forms
to be read. This may introduce new non-determinism in some  states (i.e.
things not folded), so
the resulting automaton must be folded. We carry on this process as long
as we can: but of course need to show that it halts. Suppose $L$ is the 
language accepted by the flower automaton of $K$. The image of $L$ under
the canonical map to $G$ is $K$. All the stages of our generalised folding
process will preserve this image, so our final automaton will accept a language
$L_1$ which also maps to $K$. We must then prove that if $w$ is a word
in normal form which represents an element of $K$ then $w$ is in $L_1$. It will
therefore suffice to show that if $u$ is any word in $L_1$ then the 
normal form of $u$ is also in $L_1$. 

If things get unpleasant then we  shall restrict to malnormal $H_i$ to make the generalised folding process simpler, but for now we make no such assumption.
 Recall from above that we have 
$F_1$, $F_2$ free groups (finitely generated by $X_1$ 
and $X_2$, respectively); 
 $H_1 \leq F_1$, $H_2 \leq F_2$ such that 
there exists an isomorphism $\phi: H_1 \rightarrow H_2$; a free group 
 $F(Z)$, generated by $Z=\{z_1, \ldots, z_m\}$, 
and  maps $\phi_1$ and $\phi_2$ such that 
$\phi_1(z_i)=h_i(X_1)  $ and  $\phi_2(z_i)=h^\prime_i(X_2)$, $i=1,\ldots ,m$,
both of which induce isomorphisms. 
Implicit in all this is that $X_1\cap X_2=X_1\cap Z = X_2\cap Z=\nul$. 
We define 
${G = F_1 \underset{H_1=H_2}{\ast} F_2}$, the group with  
 presentation $\la X_1,X_2 | h_i = h_i', i=1 \ldots m\ra$ and 
let $S_1$ and $S_2$ be sets of  double coset representatives of 
$H_1\le F_1$ and $H_2\le F_2$, respectively, (as in  the 
previous section).

Let $K=\la k_1, \ldots , k_s\ra$, where $k_i$ is an element of $G$ written
in normal form: say
\begin{equation}\label{eq:k-form}
k_i= h_{i,0}t_{i,1}h_{i,1}\cdots t_{i,m_i}h_{i,m_i+1},
\end{equation}
where $h_{i,j}\in F(Z)$ and $t_{i,j}\in S_1\cup S_2$.   
\subsection{Double-coset automata and graphs}
{\bf We should include a short description of Stallings folding, as in
Enric's notes from Manresa.} \\[1em]

An {\em automaton} $A$ is  a quintuple $(\S,A,\d,s_0,F)$, 
where $\S$  is finite set called the {\em alphabet}, $Q$ is a finite 
set of {\em states}, $\d$ is a map $\d:Q\times \S\maps Q$, called 
the {\em transition function}, $s_0\in Q$ is the {\em start state} and 
$F\subseteq Q$ is a set of {\em final} states. (If $F=\{s_0\}$ it's common
to drop $F$ from the description and define $A$ as a quadruple.) 

We shall associate to an automaton $A$ a rooted, directed, edge labelled graph
$\G_A$ with vertices $V=V(\G_A)=Q$, with root vertex $s_0$, 
edge set $E=E(\G_A)$ consisting
of elements $(u,\s,v)$ of $Q\times \S\times Q$ such that $\d(u,\s)=v$ and 
labelling function $l:E\maps \S$ given by $l(u,\s,v)=\s$, for all $(u,\s,v)
\in E$.  If $A$ has a property (like trim, involutive or deterministic) then
we ascribe this property to $\G_A$ as well. (Although we usually use the term
``folded'' instead of ``deterministic'', for graphs.) 

A colouring of a directed, inversive, labelled graph $\G$ is a map $c$  from $V(\G)\cup E(\G)$
 to a set $C$ such that if $\i_E$ is the involution on edges 
then $c(e)=c(\i(e))$. (We make no conditions on the colouring of vertices:
in particular adjacent vertices may have the same colour.)

\begin{definition}
A finite, rooted, directed, labelled, coloured graph $\G$ is called a 
{\em double-coset-graph} or 
{\em dc-graph}
if $\G$ has vertices, edges, labelling function and colouring function,
 $V$, $E$, $l$ and $c$, 
respectively, satisfying the following conditions.
\be[(i)]
\item $l$ is a map $l:E\maps X_1\cup X_2\cup Z$.
\item $c$ is a map $c:V\cup E\maps \ZZ\times \ZZ$. 
\item $E=E_Z\cup E_{X_1}\cup E_{X_2}$,
where $E_Z=l^{-1}(Z)$, $E_{X_1}=l^{-1}(X_1)$ and $E_{X_2}=l^{-1}(X_2)$.
\item $V=V_0\cup V_C$, where $V_C=V\bs V_0$ and 
$V_0$ is the union of 
$V_{X_1}$, $V_{X_2}$ and $V_Z$, with   
$V_Y=\{\textrm{vertices incident only to edges of } E_Y\}$, for $Y=Z,X_1$ or $X_2$. 
\item Let $c_k:V\cup E\maps \ZZ$ be the composition of $c$ with projection
onto the $k$th factor of $\ZZ\times \ZZ$, for $k=1$ or $2$. Then 
$c_k(x)\ge 0$, for all $x\in V\cup E$ and  for $k=1$ and $2$. 
\item Fix $k\in \{1,2\}$.  For all $v\in V$,  
$c_k(v)>0$ if and only if $v\in V_0$. Moreover, if $v\in V_0$ then
$c_k(v)=\max\{c_k(e): e \textrm{ is incident to } v\}$. 
\ee
An automaton $A$ is called a {\em dc-automaton} if $\G_A$ is  a dc-graph.
\end{definition}

\begin{example}\label{ex:dc-graph}
Figure \ref{fig:dc-grapha} shows a dc-graph, with root $\a$, 
where $x\in X_1$, $y_1,y_2,y_3\in X_2$,
$z\in Z$, the only vertex not in $V_0$ is $\d$, 
colours of all edges are shown and the colours of vertices  are 
$c(\a)=(3,0)$, $c(\b)=(3,0)$, $c(\g)=(0,2)$, $c(\d)=(0,0)$, $c(\e)=(0,2)$ and 
$c(\z)=(1,0)$.  
\end{example}
\begin{figure}
\begin{center}
\psfrag{a}{$\a$}
\psfrag{b}{$\b$}
\psfrag{c}{$\g$}
\psfrag{d}{$\d$}
\psfrag{e}{$\e$}
\psfrag{f}{$\z$}
\psfrag{g}{$\eta$}
\psfrag{h}{$\theta$}
\psfrag{x}{$x$}
\psfrag{z}{$z$}
\psfrag{y1}{$y_1$}
\psfrag{y2}{$y_2$}
\psfrag{y3}{$y_3$}
\psfrag{(1,0)}{$(1,0)$}
\psfrag{(0,0)}{$(0,0)$}
\psfrag{(0,2)}{$(0,2)$}
\psfrag{(3,0)}{$(3,0)$}
\subfigure[A dc-graph...]{
\includegraphics[scale=.5]{dc-graph.eps}
\label{fig:dc-grapha}
}
\hspace{15mm}
\subfigure[... and its Stallings folding]{
\includegraphics[scale=.5]{dc-folded.eps}
\label{fig:dc-graphb}
}
\end{center}
\caption{Folding a  dc-graph}\label{fig:dc-graph}
\end{figure}
An {\em elementary dc-folding} of a dc-graph $\G$ is a graph $\G^\prime$
obtained from $\G$ as follows. Suppose that $e=(p,a,q)$ and 
$e^\prime=(p,a,q^\prime)$
are edges of $\G$. (We do not require $p$, $q$ and $q^\prime$ to be distinct.) 
% with $c(p)=(m_1,n_1)$, $c(q)=(m_2,n_2)$, 
%$c(q^\prime)=(m_3,n_3)$, $c(e)=(r_1,s_1)$ and $c(e^\prime)=(r_2,s_2)$.
 Then $\G^\prime$ is the quotient of $\G$ formed by identifying 
$q$ and $q^\prime$, to form a new vertex $q^{\prime\prime}$; and 
$e$ and $e^\prime$, to form a new edge 
$e^{\prime\prime}=(p,a,q^{\prime\prime})$. If the root of $\G$ is $q$
 or $q^\prime$ then $q^{\prime\prime}$ is the root of $\G^\prime$ and otherwise
 the root of $\G^\prime$ is that of $\G$. The colouring map of $\G^\prime$
is the same as that of $\G$ except that  
 $c_k(\e^{\prime\prime})=\max\{c_k(e),c_k(e^{\prime\prime})\}$ 
and $c_k(q^{\prime\prime})=\max\{c_k(q),c_k(q^{\prime\prime})\}$,
for $k=1,2$. 
From the definition, the conditions for a dc-graph are satisfied by 
$\G^\prime$. A {\em dc-folding} of a dc-graph $\G$ is a graph obtained 
from $\G$ by a finite sequence of elementary foldings. Thus a dc-folding 
of a dc-graph is again a dc-graph. 

From now on we shall assume, unless we explicitly indicate otherwise,
 that all graphs are dc-graphs and  all foldings are dc-foldings. 
A graph on which  it is not possible to perform an elementary
folding is 
said to be {\em folded}. A {\em Stallings folding} of a graph $\G$ is
 a (possibly trivial) folding of $\G$ which is folded. As every non-trivial 
folding dedreases
 the number of edges of the graph, every graph has a Stallings folding. From the
standard theory (e.g. Enric's notes) a Stallings folding of a graph is unique,
so we may define {\em the Stallings folding} $S(\G)$ of a graph $\G$.\\
({\bf This is not quite clear, because it needs to be established that colouring
of a Stallings folding of $\G$ is not dependent on  the order of folding. It 
would be enough to show that the morphism from $\G$ to $S(\G)$ is uniquely 
determined by $\G$, but I haven't checked this out.})
\begin{example}
Figure \ref{fig:dc-graphb} shows the Stallings folding of the graph of 
Example \ref{ex:dc-graph}. Colours are shown only where the folding changes them.
\end{example}
%
%
Now let $\cF(K)$ be the flower automaton of $K$ and let 
$\G$ be the corresponding rooted graph. If $e$ is an edge of $\G$ then
$e$ is labelled by a letter (of $X_1\cup X_2 \cup Z$) 
occuring in $h_{i,j}$ or $t_{i,j}$, for some $i,j$, as in 
\eqref{eq:k-form}. If $e$ is labelled by a letter of $Z$ we say $e$ has {\em type} $Z$
and define $c(e)=(0,0)$. If $e$ is labelled by a letter of $X_k$ occuring in 
$t_{i,j}$, we say $e$ has {\em type} $X_k$ and define 
\[c_k(e)=m_1+\cdots m_{i-1} +j\textrm{ and } c_{k^\prime}(e)=0,\]
where $k\neq k^\prime$. If $v\in V_C$ then we define $c(v)=(0,0)$. If $v\in V_0$ then
 we define $c_k(v)=\max\{c_k(e): e \textrm{ is incident to } v\}$, for $k=1,2$.  
This makes $\G$ into a dc-graph. The graph of Example \ref{ex:dc-graph} is obtained 
from the subgroup $K$ generated by the single element $xzy_1y_2y_3x^{-1}$ in this way.

Now let $\D$ be the Stallings folding of the dc-graph $\G$.  
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\bibliographystyle{plain}
\bibliography{membership}
\end{document}
